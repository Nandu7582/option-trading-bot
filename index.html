<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Hedge Dashboard â€“ Open Source Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:sans-serif;padding:1rem;background:#f9f9f9;color:#333;}
    .section{margin:1rem 0;padding:1rem;background:#fff;border:1px solid #ccc;border-radius:6px;}
    button{padding:.5rem 1rem;background:#007bff;color:#fff;border:none;border-radius:4px;cursor:pointer;}
    canvas{width:100% !important;height:300px !important;}
    table{width:100%;border-collapse:collapse;margin-top:.5rem;}
    th,td{border:1px solid #ccc;padding:.5rem;text-align:center;}
  </style>
</head>
<body>
  <h2>ðŸ“Š Smart Hedge Dashboard (Fully Open Source Live)</h2>

  <!-- 1. Live Crypto Chart -->
  <div class="section">
    <h3>Live Crypto (BTC/USDT Candles)</h3>
    <canvas id="cryptoChart"></canvas>
  </div>

  <!-- 2. Live Option Chain -->
  <div class="section">
    <h3>ðŸ“ˆ Live Option Chain (Upstox)</h3>
    <table id="oiTable"><thead><tr><th>Strike</th><th>Call OI</th><th>Put OI</th><th>Î” OI%</th></tr></thead><tbody></tbody></table>
  </div>

  <!-- 3. Hedge & Max P/L -->
  <div class="section">
    <h3>Hedge + Max P/L</h3>
    <div id="signalOutput"></div>
    <canvas id="plChart"></canvas>
  </div>

  <script>
    // ---------- LIVE CRYPTO via Binance WebSocket ----------
    const socket = new WebSocket("wss://stream.binance.com:9443/ws/btcusdt@kline_1m");
    const cryptoData = { times: [], closes: [], volumes: [] };
    let cryptoChart = null;

    socket.onmessage = e => {
      const d = JSON.parse(e.data).k;
      const time = new Date(d.t).toLocaleTimeString();
      cryptoData.times.push(time);
      cryptoData.closes.push(+d.c);
      cryptoData.volumes.push(+d.v);
      if (cryptoData.times.length > 60) cryptoData.times.shift(), cryptoData.closes.shift(), cryptoData.volumes.shift();
      renderCryptoChart();
    };

    function renderCryptoChart() {
      if (!cryptoChart) {
        const ctx = document.getElementById('cryptoChart').getContext('2d');
        cryptoChart = new Chart(ctx, {
          type: 'line',
          data: { labels: cryptoData.times, datasets: [{ label: 'Close', data: cryptoData.closes, borderColor: '#007bff', fill: false }] }
        });
      } else {
        cryptoChart.data.labels = cryptoData.times;
        cryptoChart.data.datasets[0].data = cryptoData.closes;
        cryptoChart.update();
      }
    }

    // ---------- LIVE OPTION CHAIN via Upstox WebSocket ----------
    const oiSocket = new WebSocket("wss://api.upstox.com/market/feed");
    oiSocket.onopen = () => {
      const sub = { method: "sub", data: { mode: "option_chain", instrumentKeys: ["NSE_INDEX|Nifty Bank"] } };
      oiSocket.send(JSON.stringify(sub));
    };

    let latestStrikes = [];
    oiSocket.onmessage = e => {
      const d = JSON.parse(e.data).data;
      latestStrikes = d.slice(0, 6); // top 6 strikes
      updateOI();
      runAnalysis();
    };

    function updateOI() {
      const tbody = document.querySelector("#oiTable tbody");
      tbody.innerHTML = "";
      latestStrikes.forEach(s => {
        tbody.innerHTML += `<tr>
          <td>${s.strike}</td><td>${s.call_options.oi}</td><td>${s.put_options.oi}</td><td>${s.call_options.oi_change_percent.toFixed(1)}</td>
        </tr>`;
      });
    }

    // ---------- RUN ANALYSIS & P/L SIMULATION ----------
    function runAnalysis() {
      if (!latestStrikes.length) return;
      const atm = latestStrikes[Math.floor(latestStrikes.length/2)].strike;
      // Hedge: straddle at ATM
      const premiumC = latestStrikes.find(s => s.strike === atm).call_options.ltp;
      const premiumP = latestStrikes.find(s => s.strike === atm).put_options.ltp;
      const maxLoss = premiumC + premiumP;
      const prices = [];
      for (let p = atm-500; p <= atm+500; p += 50) {
        const pl = Math.max(0, p - atm) - premiumC + Math.max(0, atm - p) - premiumP;
        prices.push({ price: p, pl: pl - maxLoss });
      }

      document.getElementById("signalOutput").innerHTML = `
        <p>ATM Strike: ${atm} | Premium C+P: â‚¹${premiumC+premiumP.toFixed(2)}</p>
        <p>Basic Hedge: Long Straddle (${atm}CE & PE)</p>
      `;
      renderPL(prices);
    }

    function renderPL(data) {
      const ctx = document.getElementById('plChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels: data.map(d=>d.price), datasets:[{label:'P/L',data:data.map(d=>d.pl),borderColor:'#28a745',fill:false}] }
      });
    }
  </script>
</body>
</html>
