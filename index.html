<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nand's Kite‑Powered Watchdog Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #007bff; --text: #333; --background: #f9f9f9;
      --card: #fff; --border: #ccc;
    }
    [data-theme="dark"] {
      --text: #e0e0e0; --background: #222; --card: #333; --border: #555;
    }
    body { background:var(--background); color:var(--text); padding:1rem; font-family:sans-serif; }
    .btn { padding:.5rem 1rem; background:var(--primary); color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .section { margin:2rem 0; padding:1rem; background:var(--card); border:1px solid var(--border); border-radius:6px; }
    table { width:100%; border-collapse:collapse; margin-top:.5rem; }
    th,td { border:1px solid var(--border); padding:.5rem; text-align:center; }
    select,input { padding:.4rem; margin:.5rem 0; width:100%; max-width:300px; }
    canvas { width:100% !important; height:300px !important; }
  </style>
</head>
<body data-theme="light">
  <h1>Nand’s Smart OI Watchdog Dashboard</h1>
  <button onclick="toggleTheme()" class="btn">Toggle Theme</button>

  <!-- Live Chart -->
  <div class="section">
    <h2>Select Chart</h2>
    <select id="chartSelector">
      <option value="">--Select--</option>
      <option value="BANKNIFTY">BANKNIFTY</option>
      <option value="NIFTY">NIFTY</option>
      <option value="BTCUSDT">BTC/USDT</option>
    </select>
    <select id="intervalSelector"><option>5</option><option selected>15</option><option>60</option></select>
    <div id="tv_chart" style="height:400px"></div>
  </div>

  <!-- Option Chain/OI -->
  <div class="section">
    <h2>Live OI & Option Chain</h2>
    <input type="number" id="oiAlert" placeholder="OI change alert %" />
    <button onclick="oiAlertSet()" class="btn">Set Alert</button>
    <table id="oiTable">
      <thead><tr><th>Strike</th><th>Call OI</th><th>Put OI</th><th>ΔOI%</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Hedge + Max P/L -->
  <div class="section">
    <h2>Max P/L‑Based Hedge Suggestions</h2>
    <div id="signalList"></div>
    <div id="hedgeText"></div>
    <canvas id="plChart"></canvas>
  </div>

  <!-- Market News -->
  <div class="section">
    <h2>Latest Market News</h2>
    <ul id="newsList"></ul>
  </div>

  <script>
    let wsOI, wsNews, chart, plChart, strikes = [], oiThreshold = 10;

    function toggleTheme() {
      document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
    }

    function initChart() {
      const sel = document.getElementById('chartSelector').value;
      if (!sel) return;
      if (chart) chart.remove();
      chart = new TradingView.widget({
        container_id: "tv_chart", width: "100%", height: 400,
        symbol: sel === "BTCUSDT" ? "BINANCE:BTCUSDT" : `NSE:${sel}`,
        interval: document.getElementById('intervalSelector').value,
        theme: document.body.dataset.theme,
        toolbar_bg: "#f1f3f6", hide_top_toolbar: true
      });
    }
    document.getElementById('chartSelector').onchange = initChart;
    document.getElementById('intervalSelector').onchange = initChart;

    function createWS(url, onmsg) {
      const ws = new WebSocket(url);
      ws.onmessage = e => onmsg(JSON.parse(e.data));
      ws.onclose = () => setTimeout(() => createWS(url, onmsg), 2000);
      return ws;
    }

    wsOI = createWS('ws://localhost:5000/ws/option-chain', data => {
      strikes = data;
      renderOI();
      evaluateSignals();
      loadHedge(strikes[0]?.strike);
    });

    wsNews = createWS('ws://localhost:5000/ws/news', items => {
      document.getElementById('newsList').innerHTML = items.map(n => `<li>${n.headline} <em>(${n.sentiment})</em></li>`).join('');
    });

    function renderOI() {
      const tbody = document.querySelector('#oiTable tbody');
      tbody.innerHTML = '';
      strikes.slice(0, 5).forEach(s => {
        tbody.innerHTML += `
          <tr>
            <td>${s.strike}</td><td>${s.call_oi}</td><td>${s.put_oi}</td><td>${s.oi_change_percent.toFixed(1)}</td>
          </tr>`;
        if (Math.abs(s.oi_change_percent) >= oiThreshold) {
          notifyUser(`OI Alert on strike ${s.strike}`, `Change: ${s.oi_change_percent.toFixed(1)}%`);
        }
      });
    }

    function oiAlertSet() {
      oiThreshold = parseFloat(document.getElementById('oiAlert').value) || oiThreshold;
      alert(`OI alert threshold set to ±${oiThreshold}%`);
    }

    function notifyUser(title, body) {
      if (Notification.permission !== 'granted') Notification.requestPermission();
      new Notification(title, { body });
    }

    // Evaluate Hedge suggestions using OpenAI analysis
    async function evaluateSignals() {
      const atm = strikes[0]?.strike;
      if (!atm) return;
      const response = await fetch('/api/openai/signals', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ strikes, atm, oiThreshold })
      });
      const signals = await response.json();
      document.getElementById('signalList').innerHTML = signals.map(s => `<div>${s}</div>`).join('');
    }

    async function loadHedge(atm) {
      const res = await fetch(`/api/hedge?strike=${atm}`);
      const json = await res.json();
      document.getElementById('hedgeText').innerText = json.text;
      renderPL(json.pl_data);
    }

    function renderPL(data) {
      const ctx = document.getElementById('plChart').getContext('2d');
      if (plChart) plChart.destroy();
      plChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.price),
          datasets: [{ label: 'Max P/L', data: data.map(d => d.pl), borderColor: '#28a745', fill: false }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Underlying Price' } },
            y: { title: { display: true, text: 'Profit / Loss' } }
          }
        }
      });
    }

    window.onload = () => {
      initChart();
      if (Notification.permission !== 'granted') Notification.requestPermission();
    };
  </script>
</body>
</html>
